# Develop C# class library functions using Azure Functions

## References
> ðŸŒŸ [Develop C# class library functions](https://learn.microsoft.com/en-us/azure/azure-functions/functions-dotnet-class-library?tabs=v4%2Ccmd#functions-class-library-project) ðŸŒŸ 

## Functions class library project
- Azure Functions project template create C# class library project that contains the following files
    - host.json - stores configuration settings that affect all functions in theproject when running locally or in Azure.
    - local.settings.json - stores app settings and configuration strings that are used when running locally.

- Build output directory will follow the below folder structure
    ```
    <framework.version>
    | - bin
    | - MyFirstFunction
    | | - function.json
    | - MySecondFunction
    | | - function.json
    | - host.json
    ```

## Methods recognized as functions
- Example:
    ```csharp
    public static class SimpleExample
    {
        [FunctionName("QueueTrigger")]
        public static void Run([QueueTrigger("myqueue-items")] string queueItem, ILogger log)
        {
            log.LogInformation($"C# function processed: {queueItem}");
        }
    }
    ```
    - `FunctionName` attribute marks method as a function entry point.
        - method name can be any valid C# method name.
        - functions aren't required to be static.
    - `Trigger` attribute specifies the trigger type and binds input data to a method parameter.

## Method signature parameters
- **Input and output bindings** marked as such by decorating them with attributes.
- `ILogger` parameter for logging.
- A Cancellation parameter for graceful shutdown.
- Binding Expressions parameters to get trigger metadata.

### Output bindings
- Can have zero or multiple output bindings defined by using output parameters.
    ```csharp
    [FunctionName]
    public static void Run([QueueTrigger("myqueue")] string myQueue, [Queue("queue-destination")] out string myQueueCopy, ILogger logger)
    {
        myQueueCopy = myQueue;
    }
    ```

    - Values assigned to output bindings are written when function exits.

### Binding expressions
The below function gets queue message creation time in the `insertionTime` parameter.

```csharp
public static void Run([QueueTrigger("%queueappsetting%")] string queueItem, DateTimeOffset insertionTime, ILogger log)
{
    log.LogInformation($"Created at {insertionTime}")
}
```

### Autogenerated function.json
```json
{
    "generatedBy": "Microsoft.NET.Sdk.Functions-1.0.0.0",
    "configurationSource": "attributes",
    "bindings": [
        {
            "type": "queueTrigger",
            "queueName": "%queueapppsetting%",
            "name": "queueItem"
        }
    ],
    "disabled": false,
    "scriptFile": "..\\bin\\FunctionApp1.dll",
    "entryPoint": "FunctionApp1.QueueTrigger.Run"
}
```

### Microsoft.NET.Sdk.Functions
The function.json file generation is performed by the NuGet package [Microsoft.NET.Sdk.Functions](https://www.nuget.org/packages/Microsoft.NET.Sdk.Functions)

### Local runtime version
Visual studio uses the [Azure Functions Core Tools](https://learn.microsoft.com/en-us/azure/azure-functions/functions-run-local?tabs=windows%2Cisolated-process%2Cnode-v4%2Cpython-v2%2Chttp-trigger%2Ccontainer-apps&pivots=programming-language-csharp#install-the-azure-functions-core-tools) to run Functions Projects on your local computer.

### ReadyToRun
- Can compile function app as [ReadyToRun binaries]()
- ReadyToRun is a form of ahead-of-time compilation that can improve startup performance to help reduce the impact of cold-start when running in consumption plan
    ```xml
    <PropertyGroup>
        <TargetFramework>net6.0</TargetFramework>
        <AzureFunctionsVersion>v4</AzureFunctionsVersion>
        <PublishReadyToRun>true</PublishReadyToRun>
        <RuntimeIdentifier>win-x86</RuntimeIdentifier>
    </PropertyGroup>
    ```

### Async
- To make a function asynchronous, use the `async` keyword and return a `Task` object.

### Cancellation tokens
A function can accept a CancellationToken parameter, which enables the operating system to notify your code when the function is about to be terminated

```csharp
[FunctionName("servicebus")]
public static void Run([ServiceBusTrigger("csharpguitar", Connection = "SB_CONN")] Message[] messages, CancellationToken cancellationToken, ILogger log)
{
    if (cancellationToken.IsCancellationRequested)
    {
        return;
    }
}
```

### Logging
- ILogger
- Log custom telemetry 
    ```
    dotnet add package Microsoft.Azure.WebJobs.Logging.ApplicationInsights --version <VERSION>
    ```

### Environment variables
```csharp
private static string GetEnvironmentVariable(string name)
{
    return name + ": " +
        System.Environment.GetEnvironmentVariable(name, EnvironmentVariableTarget.Process);
}
```

### Binding at runtime
- We can use IBinder to bind the bindings at run-time, instead of design time.

